<script>
const verses=[
  {
    ref:"Roma 8:28",
    text:"Kita tahu bahwa Allah turut bekerja dalam segala sesuatu untuk mendatangkan kebaikan bagi mereka yang mengasihi Dia."
  }
];

let shuffle=null;
let lastText="", lastName="";
const verse = verses[0]; // kunci ayat

startBtn.onclick=()=>{
  lastName=name.value.trim();
  if(!lastName) return;

  name.style.display="none";
  startBtn.style.display="none";

  displayName.innerText=lastName;
  displayName.style.display="block";

  result.style.display="block";
  hint.style.display="block";
  tapArea.style.display="block";

  // tampilkan pertama kali (ANTI KOSONG)
  result.innerHTML=`<strong>${verse.ref}</strong><br><br>${verse.text}`;

  shuffle=setInterval(()=>{
    result.innerHTML=`<strong>${verse.ref}</strong><br><br>${verse.text}`;
  },80);
};

tapArea.onclick=()=>{
  clearInterval(shuffle);

  // KUNCI AYAT (INI YANG HILANG KEMARIN)
  result.innerHTML=`<strong>${verse.ref}</strong><br><br>${verse.text}`;

  tapArea.style.display="none";
  hint.style.display="none";
  actions.style.display="block";

  lastText = verse.ref + "\n\n" + verse.text;
};

function copyVerse(){
  navigator.clipboard.writeText(lastText);
}

function shareAsImage(){
  const c=canvas,ctx=c.getContext("2d");
  const bg=new Image();
  bg.src="background.jpeg";
  const logo=new Image();
  logo.src="logo.png";

  bg.onload=()=>{
    const r=Math.max(1080/bg.width,1920/bg.height);
    ctx.drawImage(
      bg,
      (1080-bg.width*r)/2,
      (1920-bg.height*r)/2,
      bg.width*r,
      bg.height*r
    );

    logo.onload=()=>{
      ctx.drawImage(logo,(1080-180)/2,420,180,180);

      ctx.fillStyle="#fff";
      ctx.textAlign="left";
      ctx.shadowColor="rgba(0,0,0,.6)";
      ctx.shadowBlur=6;

      ctx.font="bold 56px Arial";
      ctx.fillText(lastName,120,820);

      ctx.font="46px Arial";
      wrapText(ctx,lastText,120,900,840,64);

      c.toBlob(b=>{
        navigator.share({
          files:[new File([b],"ayat.png",{type:"image/png"})]
        });
      });
    };
  };
}

function wrapText(ctx,text,x,y,w,h){
  let line="";
  text.split(" ").forEach(word=>{
    const test=line+word+" ";
    if(ctx.measureText(test).width>w){
      ctx.fillText(line,x,y);
      line=word+" ";
      y+=h;
    }else{
      line=test;
    }
  });
  ctx.fillText(line,x,y);
}
</script>
