<script>
document.addEventListener("DOMContentLoaded", () => {

const verses=[
  {
    ref:"Roma 8:28",
    text:"Kita tahu bahwa Allah turut bekerja dalam segala sesuatu untuk mendatangkan kebaikan bagi mereka yang mengasihi Dia."
  }
];

let shuffle=null;
let lastText="", lastName="";
const verse = verses[0];

// ambil elemen
const name = document.getElementById("name");
const startBtn = document.getElementById("startBtn");
const displayName = document.getElementById("displayName");
const result = document.getElementById("result");
const hint = document.getElementById("hint");
const tapArea = document.getElementById("tapArea");
const actions = document.getElementById("actions");
const canvas = document.getElementById("canvas");

startBtn.onclick = () => {
  lastName = name.value.trim();
  if(!lastName) return;

  name.style.display="none";
  startBtn.style.display="none";

  displayName.innerText=lastName;
  displayName.style.display="block";

  result.style.display="block";
  hint.style.display="block";
  tapArea.style.display="block";

  // tampilkan pertama kali
  result.innerHTML=`<strong>${verse.ref}</strong><br><br>${verse.text}`;

  shuffle=setInterval(()=>{
    result.innerHTML=`<strong>${verse.ref}</strong><br><br>${verse.text}`;
  },80);
};

tapArea.onclick = () => {
  clearInterval(shuffle);

  result.innerHTML=`<strong>${verse.ref}</strong><br><br>${verse.text}`;

  tapArea.style.display="none";
  hint.style.display="none";
  actions.style.display="block";

  lastText = verse.ref + "\n\n" + verse.text;
};

function copyVerse(){
  navigator.clipboard.writeText(lastText);
}

function loadImage(src){
  return new Promise(res=>{
    const img=new Image();
    img.src=src;
    img.onload=()=>res(img);
  });
}

async function shareAsImage(){
  const c = canvas;
  const ctx = c.getContext("2d");

  c.width = 1080;
  c.height = 1920;
  ctx.clearRect(0,0,c.width,c.height);

  const bg = await loadImage("background.jpeg");
  const logo = await loadImage("logo.png");

  const r = Math.max(1080/bg.width,1920/bg.height);
  ctx.drawImage(
    bg,
    (1080-bg.width*r)/2,
    (1920-bg.height*r)/2,
    bg.width*r,
    bg.height*r
  );

  ctx.drawImage(logo,(1080-180)/2,420,180,180);

  ctx.fillStyle="#fff";
  ctx.textAlign="left";
  ctx.shadowColor="rgba(0,0,0,.6)";
  ctx.shadowBlur=6;

  ctx.font="bold 56px Arial";
  ctx.fillText(lastName,120,820);

  ctx.font="46px Arial";
  wrapText(ctx,lastText,120,900,840,64);

  c.toBlob(b=>{
    if(navigator.share){
      navigator.share({
        files:[new File([b],"ayat.png",{type:"image/png"})]
      });
    }
  });
}

function wrapText(ctx,text,x,y,w,h){
  let line="";
  text.split(" ").forEach(word=>{
    const test=line+word+" ";
    if(ctx.measureText(test).width>w){
      ctx.fillText(line,x,y);
      line=word+" ";
      y+=h;
    }else{
      line=test;
    }
  });
  ctx.fillText(line,x,y);
}

window.copyVerse = copyVerse;
window.shareAsImage = shareAsImage;

});
    </script>
